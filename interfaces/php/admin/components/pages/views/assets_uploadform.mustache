{{#AWSAccessKeyId}}
<form id="file_upload" method="post" class="nodefaultajax" action="https://cashmusicdemo.s3.amazonaws.com/" enctype="multipart/form-data">
	<input type="hidden" name="key" value="{{key}}" />
	<input type="hidden" name="AWSAccessKeyId" value="{{AWSAccessKeyId}}" />
	<input type="hidden" name="acl" value="{{acl}}" />
	<input type="hidden" name="success_action_status" value="{{success_action_status}}" />
	<input type="hidden" name="policy" value="{{policy}}" />
	<input type="hidden" name="signature" value="{{signature}}" />
	<input type="file" name="file" />
</form>

<div id="loading">uploading...</div>

<script src="{{www_path}}/ui/default/assets/scripts/jquery.iframe-transport.js"></script>
<script src="{{www_path}}/ui/default/assets/scripts/jquery.fileupload.js"></script>

<script type="text/javascript">
	$(function() {
		var filename,filekey,connectionId,finalizeUrl;
		filekey = '{{key}}';
		connectionId = '{{connection_id}}';
		finalizeUrl = '{{www_path}}/ajax/finalizeupload';
		$('#loading').hide();

		$('#file_upload').fileupload({
			forceIframeTransport: true,
			autoUpload: true,
			add: function (e, data) {
				// remember the filename and submit
				filename = data.files[0].name;
				data.submit();
			},
			send: function(e, data) {
				// spinner, etc
				$('#loading').show();
			},
			fail: function(e, data) {
				// we should do something useful here
			},
			done: function (event, data) {
				// hide the spinner, add the final key to the location field of the 
				// main form, call ajax/finalizeupload with the key
				$('#loading').hide();
				var finalkey = filekey.replace('${filename}','') + filename;
				/*
				 *
				 * 
				 *
				 * here we set the location, then try MIME type in the background. MIME takes about 
				 * an extra second or two to finalize, but basically it's all set as soon as we 
				 * request the ajax/finalizeupload method. no point in waiting for confirmation 
				 * since we won't do things differently on failure.
				 * 
				 * location = finalkey
				 *
				 *
				 *
				 */
				jQuery.post(finalizeUrl, 'connection_id='+connectionId+'&filename='+finalkey, function(data) {
					if (data.success) {
						alert('done: ' + finalkey);
					} else {
						alert('done, but could not set MIME type: ' + finalkey);
					}
				},'json');
			}
		});
	});
</script>
{{/AWSAccessKeyId}}
{{^AWSAccessKeyId}}
	You need to choose a connection.
{{/AWSAccessKeyId}}